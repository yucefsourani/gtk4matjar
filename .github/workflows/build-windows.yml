{% macro gh(expression) -%}
{{ '${{ ' ~ expression ~ ' }}' }}
{%- endmacro %}

name: Build Windows Executable

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build (leave empty for latest commit)'
        required: false
        default: ''
permissions:
  contents: write
jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: {{ gh('github.event.inputs.release_tag || github.ref') }}
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-libadwaita
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-gobject
            mingw-w64-x86_64-gstreamer
            mingw-w64-x86_64-gst-plugins-base
            mingw-w64-x86_64-gst-plugins-good
            mingw-w64-x86_64-gst-plugins-bad
            mingw-w64-x86_64-gst-plugins-ugly
            mingw-w64-x86_64-gst-libav
            mingw-w64-x86_64-pyinstaller
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-python-sqlmodel
            mingw-w64-x86_64-gettext
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gettext-tools
            base-devel
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
      
      - name: Compile GResources
        run: |
          cd src/{{ NEW_NAME }}/resources
          glib-compile-resources {{ NEW_NAME }}.gresource.xml
          ls -la
      
      - name: Build with PyInstaller
        run: |
          pyinstaller pyinstaller/{{ NEW_NAME }}.spec
      
      - name: Create portable marker
        run: |
          touch dist/{{ NEW_NAME }}/portable.txt
          mkdir -p dist/{{ NEW_NAME }}/data
      
      - name: Create ZIP archive
        shell: pwsh
        run: |
          $version = if ($env:GITHUB_REF_TYPE -eq 'tag') { $env:GITHUB_REF_NAME } else { 'dev' }
          Compress-Archive -Path dist/{{ NEW_NAME }}/* -DestinationPath "{{ NEW_NAME }}-windows-$version.zip"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ NEW_NAME }}-windows
          path: {{ NEW_NAME }}-windows-*.zip
          retention-days: 30
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: {{ NEW_NAME }}-windows-*.zip
        env:
          GITHUB_TOKEN: {{ gh('secrets.GITHUB_TOKEN') }}
